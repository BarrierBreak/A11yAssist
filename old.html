<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A11yAssist by BarrierBreak - Natural Language Database Query Interface">
    <title>A11yAssist - BarrierBreak</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-orange: #FF6B35;
            --secondary-orange: #FFA07A;
            --light-orange: #FFE5D9;
            --pale-orange: #FFF8F3;
            --dark-text: #2C3E50;
            --gray-text: #6C757D;
            --border-color: #FFE5D9;
            --success-green: #28A745;
            --error-red: #DC3545;
            --code-bg: #F5F5F5;
            --white: #FFFFFF;
            --shadow: 0 2px 8px rgba(255, 107, 53, 0.1);
            --shadow-lg: 0 4px 16px rgba(255, 107, 53, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--pale-orange);
            color: var(--dark-text);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-orange));
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .company-name {
            font-size: 0.875rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Main Container */
        .container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 72px);
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: var(--light-orange);
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 4px;
        }

        /* Message Bubbles */
        .message {
            display: flex;
            gap: 1rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-orange));
            color: var(--white);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-text {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* Collapsible Panels */
        .panel {
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--pale-orange);
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--white);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .panel-header:hover {
            background: var(--light-orange);
        }

        .panel-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-icon {
            transition: transform 0.3s;
        }

        .panel.collapsed .panel-icon {
            transform: rotate(-90deg);
        }

        .panel-body {
            padding: 1rem;
            max-height: 500px;
            overflow: auto;
            transition: max-height 0.3s ease-out;
        }

        .panel.collapsed .panel-body {
            max-height: 0;
            padding: 0;
            overflow: hidden;
        }

        /* SQL Code Block */
        .sql-code {
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--dark-text);
        }

        /* Data Table */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            font-size: 0.875rem;
        }

        thead {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-orange));
            color: var(--white);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        tbody tr:nth-child(even) {
            background: var(--pale-orange);
        }

        tbody tr:hover {
            background: var(--light-orange);
        }

        td {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .table-info {
            font-size: 0.875rem;
            color: var(--gray-text);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-text);
        }

        /* Metadata Display */
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .metadata-item {
            background: var(--white);
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .metadata-label {
            font-size: 0.75rem;
            color: var(--gray-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .metadata-value {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 0.95rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background: var(--light-orange);
            color: var(--primary-orange);
        }

        .badge-success {
            background: #D4EDDA;
            color: var(--success-green);
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            padding: 0.25rem 0.75rem;
            background: var(--light-orange);
            color: var(--primary-orange);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Input Area */
        .input-container {
            background: var(--white);
            border-top: 2px solid var(--border-color);
            padding: 1.5rem 2rem;
            box-shadow: 0 -2px 8px rgba(255, 107, 53, 0.1);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            max-width: 1200px;
            margin: 0 auto;
        }

        .input-field {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-orange));
            color: var(--white);
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
            min-height: 44px;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-send:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading-message {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 70%;
            box-shadow: var(--shadow);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--light-orange);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            color: var(--gray-text);
            font-size: 0.875rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--dark-text);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-orange));
            color: var(--white);
            border: none;
            padding: 0.875rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #F8D7DA;
            color: var(--error-red);
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.875rem;
            border: 1px solid var(--error-red);
        }

        .error-box {
            background: #F8D7DA;
            border: 1px solid var(--error-red);
            color: var(--error-red);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        /* Copy Button */
        .btn-copy {
            background: var(--light-orange);
            color: var(--primary-orange);
            border: 1px solid var(--primary-orange);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-copy:hover {
            background: var(--primary-orange);
            color: var(--white);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .header-left,
            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .chat-container {
                padding: 1rem;
            }

            .message-content {
                max-width: 85%;
            }

            .input-container {
                padding: 1rem;
            }

            .input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-send {
                width: 100%;
            }

            .metadata-grid {
                grid-template-columns: 1fr;
            }

            .company-name {
                display: none;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 3rem 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-title {
            font-size: 2rem;
            color: var(--primary-orange);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .welcome-text {
            color: var(--gray-text);
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .welcome-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal active">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">A11yAssist</div>
                <div class="modal-subtitle">by BarrierBreak</div>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="connStr" class="form-label">PostgreSQL Connection String</label>
                    <input
                        type="text"
                        id="connStr"
                        class="form-input"
                        placeholder="postgresql://user:password@host:port/database"
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="azureEndpoint" class="form-label">Azure OpenAI Endpoint</label>
                    <input
                        type="text"
                        id="azureEndpoint"
                        class="form-input"
                        placeholder="https://your-resource.openai.azure.com/openai/deployments/..."
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="azureKey" class="form-label">Azure OpenAI API Key</label>
                    <input
                        type="password"
                        id="azureKey"
                        class="form-input"
                        placeholder="Enter your Azure API key"
                        required
                    >
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">
                    Connect
                </button>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <header class="header">
            <div class="header-left">
                <div class="logo">A11yAssist</div>
                <div class="company-name">BarrierBreak</div>
            </div>
            <div class="header-right">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>Connected</span>
                </div>
                <button class="btn-logout" id="logoutBtn">Logout</button>
            </div>
        </header>

        <div class="container">
            <div id="chatContainer" class="chat-container">
                <div class="welcome-message">
    <h1 class="welcome-title">Welcome to A11yAssist</h1>
    <ul class="welcome-text">
        <li>List all projects with the number of pages in each project.</li>
        <li>List all projects with the total number of issues in each project.</li>
        <li>For each project, show the latest scan result date for every page.</li>
        <li>List pages in Project Amazon with the number of issues in each page.</li>
        <li>Show projects with the total number of issues grouped by issue status.</li>
        <li>For each issue, show the count of activities associated with it.</li>
        <li>List top 10 pages with the highest number of issues (show page name and count).</li>
        <li>Show count of issues per project filtered by scan results that ended in error.</li>
        <li>For each project, show total number of issues and total number of activities.</li>
        <li>List issue counts with their scan result status and project name.</li>
        <li>List all users with their role names and the count of projects they are assigned to.</li>
        <li>For each role, show the number of users and total issues in their projects.</li>
        <li>Show projects with assigned users, their roles, and total page count.</li>
        <li>Find users with activities logged for issues in their projects and list role.</li>
        <li>List projects with assigned users, roles, and count of critical issues.</li>
    </ul>
</div>

            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea
                        id="queryInput"
                        class="input-field"
                        placeholder="Ask a question about your data..."
                        rows="1"
                        aria-label="Enter your query"
                    ></textarea>
                    <button id="sendBtn" class="btn-send" aria-label="Send query">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Management
        const state = {
        isAuthenticated: false,
        // Auto-detect: use current origin if served from same server, else localhost for dev
        apiBaseUrl: window.location.hostname === 'localhost' 
            ? 'http://localhost:8080' 
            : window.location.origin,
        messages: []
    };

        // DOM Elements
        const elements = {
            loginModal: document.getElementById('loginModal'),
            loginForm: document.getElementById('loginForm'),
            loginBtn: document.getElementById('loginBtn'),
            loginError: document.getElementById('loginError'),
            app: document.getElementById('app'),
            chatContainer: document.getElementById('chatContainer'),
            queryInput: document.getElementById('queryInput'),
            sendBtn: document.getElementById('sendBtn'),
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Utility Functions
        function formatTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatColumnName(name) {
            return name
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could add a toast notification here
            });
        }

        // API Functions
        async function login(connStr, azureEndpoint, azureKey) {
            const response = await fetch(`${state.apiBaseUrl}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    conn_str: connStr,
                    azure_endpoint: azureEndpoint,
                    azure_key: azureKey
                }),
                credentials: 'include'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Login failed');
            }

            return await response.json();
        }

        async function sendQuery(query) {
            const response = await fetch(`${state.apiBaseUrl}/query`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    execute: true
                }),
                credentials: 'include'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Query failed');
            }

            return await response.json();
        }

        // UI Rendering Functions
        function createUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${escapeHtml(text)}</div>
                    <div class="message-time">${formatTimestamp()}</div>
                </div>
            `;
            return messageDiv;
        }

        function createLoadingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = `
                <div class="loading-message">
                    <div class="spinner"></div>
                    <div>Analyzing your query...</div>
                </div>
            `;
            return messageDiv;
        }

        function createDataTable(data, pagination) {
            if (!data || data.length === 0) {
                return '<div class="empty-state">No results found</div>';
            }

            const columns = Object.keys(data[0]);
            const totalResults = pagination?.total_results || data.length;
            const pageSize = pagination?.page_size || data.length;
            const page = pagination?.page || 1;
            const start = ((page - 1) * pageSize) + 1;
            const end = Math.min(start + data.length - 1, totalResults);

            let html = `
                <div class="table-info">
                    Showing ${start}-${end} of ${totalResults} results
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                ${columns.map(col => `<th>${formatColumnName(col)}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col];
                    if (value === null || value === undefined) {
                        value = '<em>null</em>';
                    } else if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    } else {
                        value = escapeHtml(String(value));
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        function createMetadataDisplay(metadata, tablesUsed) {
            return `
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <div class="metadata-label">Execution Time</div>
                        <div class="metadata-value">${metadata.execution_time_ms}ms</div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Query Type</div>
                        <div class="metadata-value">
                            <span class="badge badge-primary">${metadata.query_type}</span>
                        </div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Joins Used</div>
                        <div class="metadata-value">
                            <span class="badge ${metadata.joins_used ? 'badge-success' : 'badge-primary'}">
                                ${metadata.joins_used ? 'Yes' : 'No'}
                            </span>
                        </div>
                    </div>
                    <div class="metadata-item">
                        <div class="metadata-label">Tables Used</div>
                        <div class="tags">
                            ${tablesUsed.map(table => `<span class="tag">${table}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function createAssistantMessage(response) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';

            const narrative = response.narrative?.answer || 'Query executed successfully.';
            const hasData = response.data?.results && response.data.results.length > 0;
            const hasError = response.execution_error;

            let contentHtml = `
                <div class="message-content">
                    <div class="message-text">${escapeHtml(narrative)}</div>
            `;

            if (hasError) {
                contentHtml += `
                    <div class="error-box">
                        <strong>Error:</strong> ${escapeHtml(hasError)}
                    </div>
                `;
            }

            // SQL Panel
            if (response.generated_sql) {
                const sqlId = 'sql-' + Date.now();
                contentHtml += `
                    <div class="panel" id="${sqlId}">
                        <div class="panel-header" onclick="togglePanel('${sqlId}')">
                            <div class="panel-title">
                                <span class="panel-icon">▼</span>
                                View SQL Query
                            </div>
                            <button class="btn-copy" onclick="event.stopPropagation(); copyToClipboard(\`${response.generated_sql.replace(/`/g, '\\`')}\`)">
                                Copy
                            </button>
                        </div>
                        <div class="panel-body">
                            <pre class="sql-code">${escapeHtml(response.generated_sql)}</pre>
                        </div>
                    </div>
                `;
            }

            // Data Panel
            if (hasData) {
                const dataId = 'data-' + Date.now();
                contentHtml += `
                    <div class="panel" id="${dataId}">
                        <div class="panel-header" onclick="togglePanel('${dataId}')">
                            <div class="panel-title">
                                <span class="panel-icon">▼</span>
                                Data Preview
                            </div>
                        </div>
                        <div class="panel-body">
                            ${createDataTable(response.data.results, response.data)}
                        </div>
                    </div>
                `;
            }

            // Metadata Panel
            if (response.metadata) {
                const metaId = 'meta-' + Date.now();
                contentHtml += `
                    <div class="panel collapsed" id="${metaId}">
                        <div class="panel-header" onclick="togglePanel('${metaId}')">
                            <div class="panel-title">
                                <span class="panel-icon">▼</span>
                                Query Metadata
                            </div>
                        </div>
                        <div class="panel-body">
                            ${createMetadataDisplay(response.metadata, response.tables_used)}
                        </div>
                    </div>
                `;
            }

            contentHtml += `
                    <div class="message-time">${formatTimestamp()}</div>
                </div>
            `;

            messageDiv.innerHTML = contentHtml;
            return messageDiv;
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('collapsed');
            }
        }

        function scrollToBottom() {
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        function clearWelcomeMessage() {
            const welcome = elements.chatContainer.querySelector('.welcome-message');
            if (welcome) {
                welcome.remove();
            }
        }

        // Event Handlers
        async function handleLogin(e) {
            e.preventDefault();

            const connStr = document.getElementById('connStr').value.trim();
            const azureEndpoint = document.getElementById('azureEndpoint').value.trim();
            const azureKey = document.getElementById('azureKey').value.trim();

            elements.loginBtn.disabled = true;
            elements.loginBtn.textContent = 'Connecting...';
            elements.loginError.style.display = 'none';

            try {
                await login(connStr, azureEndpoint, azureKey);
                state.isAuthenticated = true;
                elements.loginModal.classList.remove('active');
                elements.app.style.display = 'block';
                elements.queryInput.focus();
            } catch (error) {
                elements.loginError.textContent = error.message;
                elements.loginError.style.display = 'block';
            } finally {
                elements.loginBtn.disabled = false;
                elements.loginBtn.textContent = 'Connect';
            }
        }

        function handleLogout() {
            state.isAuthenticated = false;
            state.messages = [];
            elements.app.style.display = 'none';
            elements.loginModal.classList.add('active');
            elements.chatContainer.innerHTML = `
                <div class="welcome-message">
                    
                    <h1 class="welcome-title">Welcome to A11yAssist</h1>
                    <p class="welcome-text">
                        "List all projects with the number of pages in each project.",
                        "List all projects with the total number of issues in each project.",
                        "For each project, show the latest scan result date for every page.",
                        "List pages in Project Amazon with the number of issues in each page.",
                        "Show projects with the total number of issues grouped by issue status.",
                        "For each issue, show the count of activities associated with it.",
                        "List top 10 pages with the highest number of issues (show page name and count).",
                        "Show count of issues per project filtered by scan results that ended in error.",
                        "For each project, show total number of issues and total number of activities.",
                        "List issue counts with their scan result status and project name.",
                        "List all users with their role names and the count of projects they are assigned to.",
                        "For each role, show the number of users and total issues in their projects.",
                        "Show projects with assigned users, their roles, and total page count.",
                        "Find users with activities logged for issues in their projects and list role.",
                        "List projects with assigned users, roles, and count of critical issues."
                    </p>
                </div>
            `;
            elements.loginForm.reset();
        }

        async function handleSendQuery() {
            const query = elements.queryInput.value.trim();

            if (!query) return;

            clearWelcomeMessage();

            // Add user message
            const userMessage = createUserMessage(query);
            elements.chatContainer.appendChild(userMessage);
            scrollToBottom();

            // Clear input
            elements.queryInput.value = '';
            elements.queryInput.style.height = 'auto';
            elements.sendBtn.disabled = true;

            // Add loading message
            const loadingMessage = createLoadingMessage();
            elements.chatContainer.appendChild(loadingMessage);
            scrollToBottom();

            try {
                const response = await sendQuery(query);

                // Remove loading message
                loadingMessage.remove();

                // Add assistant response
                const assistantMessage = createAssistantMessage(response);
                elements.chatContainer.appendChild(assistantMessage);
                scrollToBottom();

            } catch (error) {
                loadingMessage.remove();

                const errorResponse = {
                    narrative: { answer: 'I encountered an error processing your query.' },
                    execution_error: error.message
                };

                const errorMessage = createAssistantMessage(errorResponse);
                elements.chatContainer.appendChild(errorMessage);
                scrollToBottom();
            } finally {
                elements.sendBtn.disabled = false;
                elements.queryInput.focus();
            }
        }

        // Input handling
        elements.queryInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        elements.queryInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendQuery();
            }
        });

        // Event Listeners
        elements.loginForm.addEventListener('submit', handleLogin);
        elements.sendBtn.addEventListener('click', handleSendQuery);
        elements.logoutBtn.addEventListener('click', handleLogout);

        // Global function for toggling panels (called from onclick)
        window.togglePanel = togglePanel;
        window.copyToClipboard = copyToClipboard;

        // Initialize
        elements.queryInput.focus();
    </script>
</body>
</html>
